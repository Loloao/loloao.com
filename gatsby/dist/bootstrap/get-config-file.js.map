{"version":3,"file":"get-config-file.js","names":["getConfigFile","siteDirectory","configName","distance","compiledResult","attemptImportCompiled","configModule","configFilePath","uncompiledResult","attemptImportUncompiled","attemptImport","configPath","resolveJSFilepath","rootDir","filePath","undefined","importedModule","maybeAddFileProtocol","preferDefault","compiledConfigPath","path","join","COMPILED_CACHE_DIR","error","report","panic","id","context","message","uncompiledConfigPath","testImportError","Error","tsConfig","nearMatch","checkTsAndNearMatch","isTSX","endsWith","isInSrcDir","warn","files","fs","readdir","file","name","ext","parse","isNearMatch"],"sources":["../../src/bootstrap/get-config-file.ts"],"sourcesContent":["import fs from \"fs-extra\"\nimport { testImportError } from \"../utils/test-import-error\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport path from \"path\"\nimport { COMPILED_CACHE_DIR } from \"../utils/parcel/compile-gatsby-files\"\nimport { isNearMatch } from \"../utils/is-near-match\"\nimport { resolveJSFilepath, maybeAddFileProtocol } from \"./resolve-js-file-path\"\nimport { preferDefault } from \"./prefer-default\"\n\nexport async function getConfigFile(\n  siteDirectory: string,\n  configName: string,\n  distance: number = 3\n): Promise<{\n  configModule: any\n  configFilePath: string\n}> {\n  const compiledResult = await attemptImportCompiled(siteDirectory, configName)\n\n  if (compiledResult?.configModule && compiledResult?.configFilePath) {\n    return compiledResult\n  }\n\n  const uncompiledResult = await attemptImportUncompiled(\n    siteDirectory,\n    configName,\n    distance\n  )\n\n  return uncompiledResult || {}\n}\n\nasync function attemptImport(\n  siteDirectory: string,\n  configPath: string\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  const configFilePath = await resolveJSFilepath({\n    rootDir: siteDirectory,\n    filePath: configPath,\n  })\n\n  // The file does not exist, no sense trying to import it\n  if (!configFilePath) {\n    return { configFilePath: ``, configModule: undefined }\n  }\n\n  const importedModule = await import(maybeAddFileProtocol(configFilePath))\n  const configModule = preferDefault(importedModule)\n\n  return { configFilePath, configModule }\n}\n\nasync function attemptImportCompiled(\n  siteDirectory: string,\n  configName: string\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  let compiledResult\n\n  try {\n    const compiledConfigPath = path.join(\n      `${siteDirectory}/${COMPILED_CACHE_DIR}`,\n      configName\n    )\n    compiledResult = await attemptImport(siteDirectory, compiledConfigPath)\n  } catch (error) {\n    report.panic({\n      id: `11902`,\n      error: error,\n      context: {\n        configName,\n        message: error.message,\n      },\n    })\n  }\n\n  return compiledResult\n}\n\nasync function attemptImportUncompiled(\n  siteDirectory: string,\n  configName: string,\n  distance: number\n): Promise<{\n  configModule: unknown\n  configFilePath: string\n}> {\n  let uncompiledResult\n\n  const uncompiledConfigPath = path.join(siteDirectory, configName)\n\n  try {\n    uncompiledResult = await attemptImport(siteDirectory, uncompiledConfigPath)\n  } catch (error) {\n    if (!testImportError(uncompiledConfigPath, error)) {\n      report.panic({\n        id: `10123`,\n        error,\n        context: {\n          configName,\n          message: error.message,\n        },\n      })\n    }\n  }\n\n  if (uncompiledResult?.configFilePath) {\n    return uncompiledResult\n  }\n\n  const error = new Error(`Cannot find package '${uncompiledConfigPath}'`)\n\n  const { tsConfig, nearMatch } = await checkTsAndNearMatch(\n    siteDirectory,\n    configName,\n    distance\n  )\n\n  // gatsby-config.ts exists but compiled gatsby-config.js does not\n  if (tsConfig) {\n    report.panic({\n      id: `10127`,\n      error,\n      context: {\n        configName,\n      },\n    })\n  }\n\n  // gatsby-config is misnamed\n  if (nearMatch) {\n    const isTSX = nearMatch.endsWith(`.tsx`)\n    report.panic({\n      id: `10124`,\n      error,\n      context: {\n        configName,\n        nearMatch,\n        isTSX,\n      },\n    })\n  }\n\n  // gatsby-config is incorrectly located in src directory\n  const isInSrcDir = await resolveJSFilepath({\n    rootDir: siteDirectory,\n    filePath: path.join(siteDirectory, `src`, configName),\n    warn: false,\n  })\n\n  if (isInSrcDir) {\n    report.panic({\n      id: `10125`,\n      context: {\n        configName,\n      },\n    })\n  }\n\n  return uncompiledResult\n}\n\nasync function checkTsAndNearMatch(\n  siteDirectory: string,\n  configName: string,\n  distance: number\n): Promise<{\n  tsConfig: boolean\n  nearMatch: string\n}> {\n  const files = await fs.readdir(siteDirectory)\n\n  let tsConfig = false\n  let nearMatch = ``\n\n  for (const file of files) {\n    if (tsConfig || nearMatch) {\n      break\n    }\n\n    const { name, ext } = path.parse(file)\n\n    if (name === configName && ext === `.ts`) {\n      tsConfig = true\n      break\n    }\n\n    if (isNearMatch(name, configName, distance)) {\n      nearMatch = file\n    }\n  }\n\n  return {\n    tsConfig,\n    nearMatch,\n  }\n}\n"],"mappings":"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"}