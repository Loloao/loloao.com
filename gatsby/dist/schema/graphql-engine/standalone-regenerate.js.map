{"version":3,"file":"standalone-regenerate.js","names":["run","console","log","loadConfigAndPlugins","siteDirectory","process","cwd","fs","remove","e","state","store","getState","buildActivityTimer","reporter","activityTimer","start","Promise","all","createGraphqlEngineBundle","createPageSSRBundle","rootDir","components","staticQueriesByTemplate","webpackCompilationHash","isVerbose","program","verbose","err","panic","end","validateEnginesActivity","validateEngines","error","id","context"],"sources":["../../../src/schema/graphql-engine/standalone-regenerate.ts"],"sourcesContent":["#!/usr/bin/env node\n\n/*\nthis is used for development purposes only\nto be able to run `gatsby build` once to source data\nand print schema and then just rebundle graphql-engine\nwith source file changes and test re-built engine quickly\n\nUsage:\nThere need to be at least one successful `gatsby build`\nbefore starting to use this script (warm up datastore,\ngenerate \"page-ssr\" bundle). Once that's done you can\nrun following command in test site directory:\n\n```shell\nnode node_modules/gatsby/dist/schema/graphql-engine/standalone-regenerate.js\n```\n*/\n\nimport { createGraphqlEngineBundle } from \"./bundle-webpack\"\nimport { createPageSSRBundle } from \"./../../utils/page-ssr-module/bundle-webpack\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { loadConfigAndPlugins } from \"../../utils/worker/child/load-config-and-plugins\"\nimport * as fs from \"fs-extra\"\nimport { store } from \"../../redux\"\nimport { validateEngines } from \"../../utils/validate-engines\"\n\nasync function run(): Promise<void> {\n  // load config\n  console.log(`loading config and plugins`)\n  await loadConfigAndPlugins({\n    siteDirectory: process.cwd(),\n  })\n\n  try {\n    console.log(`clearing webpack cache\\n\\n`)\n    // get rid of cache if it exist\n    await fs.remove(process.cwd() + `/.cache/webpack/query-engine`)\n    await fs.remove(process.cwd() + `/.cache/webpack/page-ssr`)\n  } catch (e) {\n    // eslint-disable no-empty\n  }\n\n  const state = store.getState()\n\n  // recompile\n  const buildActivityTimer = reporter.activityTimer(\n    `Building Rendering Engines`\n  )\n  try {\n    buildActivityTimer.start()\n    await Promise.all([\n      createGraphqlEngineBundle(process.cwd(), reporter, true),\n      createPageSSRBundle({\n        rootDir: process.cwd(),\n        components: store.getState().components,\n        staticQueriesByTemplate: state.staticQueriesByTemplate,\n        webpackCompilationHash: state.webpackCompilationHash, // we set webpackCompilationHash above\n        reporter,\n        isVerbose: state.program.verbose,\n      }),\n    ])\n  } catch (err) {\n    buildActivityTimer.panic(err)\n  } finally {\n    buildActivityTimer.end()\n  }\n\n  // validate\n  const validateEnginesActivity = reporter.activityTimer(\n    `Validating Rendering Engines`\n  )\n  validateEnginesActivity.start()\n  try {\n    await validateEngines(process.cwd())\n  } catch (error) {\n    validateEnginesActivity.panic({ id: `98001`, context: {}, error })\n  } finally {\n    validateEnginesActivity.end()\n  }\n\n  console.log(`DONE`)\n}\n\nrun()\n"],"mappings":"AAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;AAEA,eAAeA,GAAf,GAAoC;EAClC;EACAC,OAAO,CAACC,GAAR,CAAa,4BAAb;EACA,MAAM,IAAAC,0CAAA,EAAqB;IACzBC,aAAa,EAAEC,OAAO,CAACC,GAAR;EADU,CAArB,CAAN;;EAIA,IAAI;IACFL,OAAO,CAACC,GAAR,CAAa,4BAAb,EADE,CAEF;;IACA,MAAMK,EAAE,CAACC,MAAH,CAAUH,OAAO,CAACC,GAAR,KAAiB,8BAA3B,CAAN;IACA,MAAMC,EAAE,CAACC,MAAH,CAAUH,OAAO,CAACC,GAAR,KAAiB,0BAA3B,CAAN;EACD,CALD,CAKE,OAAOG,CAAP,EAAU,CACV;EACD;;EAED,MAAMC,KAAK,GAAGC,YAAA,CAAMC,QAAN,EAAd,CAhBkC,CAkBlC;;;EACA,MAAMC,kBAAkB,GAAGC,iBAAA,CAASC,aAAT,CACxB,4BADwB,CAA3B;;EAGA,IAAI;IACFF,kBAAkB,CAACG,KAAnB;IACA,MAAMC,OAAO,CAACC,GAAR,CAAY,CAChB,IAAAC,wCAAA,EAA0Bd,OAAO,CAACC,GAAR,EAA1B,EAAyCQ,iBAAzC,EAAmD,IAAnD,CADgB,EAEhB,IAAAM,mCAAA,EAAoB;MAClBC,OAAO,EAAEhB,OAAO,CAACC,GAAR,EADS;MAElBgB,UAAU,EAAEX,YAAA,CAAMC,QAAN,GAAiBU,UAFX;MAGlBC,uBAAuB,EAAEb,KAAK,CAACa,uBAHb;MAIlBC,sBAAsB,EAAEd,KAAK,CAACc,sBAJZ;MAIoC;MACtDV,QAAQ,EAARA,iBALkB;MAMlBW,SAAS,EAAEf,KAAK,CAACgB,OAAN,CAAcC;IANP,CAApB,CAFgB,CAAZ,CAAN;EAWD,CAbD,CAaE,OAAOC,GAAP,EAAY;IACZf,kBAAkB,CAACgB,KAAnB,CAAyBD,GAAzB;EACD,CAfD,SAeU;IACRf,kBAAkB,CAACiB,GAAnB;EACD,CAvCiC,CAyClC;;;EACA,MAAMC,uBAAuB,GAAGjB,iBAAA,CAASC,aAAT,CAC7B,8BAD6B,CAAhC;;EAGAgB,uBAAuB,CAACf,KAAxB;;EACA,IAAI;IACF,MAAM,IAAAgB,gCAAA,EAAgB3B,OAAO,CAACC,GAAR,EAAhB,CAAN;EACD,CAFD,CAEE,OAAO2B,KAAP,EAAc;IACdF,uBAAuB,CAACF,KAAxB,CAA8B;MAAEK,EAAE,EAAG,OAAP;MAAeC,OAAO,EAAE,EAAxB;MAA4BF;IAA5B,CAA9B;EACD,CAJD,SAIU;IACRF,uBAAuB,CAACD,GAAxB;EACD;;EAED7B,OAAO,CAACC,GAAR,CAAa,MAAb;AACD;;AAEDF,GAAG"}